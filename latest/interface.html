<!DOCTYPE html>
<html lang="ru">
<head>
<meta charset="UTF-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1.0"/>
<title>–ö–æ–Ω—Ç—Ä–æ–ª—å —Ç–µ–º–ø–µ—Ä–∞—Ç—É—Ä—ã</title>
<style>
body{margin:0;padding:0;font-family:sans-serif;background-color:#333;color:white;display:flex;flex-direction:column;align-items:center;height:100vh;overflow:hidden;position:relative}
.menu-icon{position:absolute;top:1rem;right:1rem;font-size:2rem;cursor:pointer;z-index:1000;padding:0.5rem}
.menu-icon:hover{color:#00E5C0}
.connection-status{position:absolute;top:1rem;left:1rem;font-size:0.9rem;padding:0.5rem 1rem;border-radius:4px;background:#555;z-index:999}
.connection-status.connected{background:#00E5C0;color:#000}
.connection-status.disconnected{background:#ff4444;color:white}
.modal{display:none;position:fixed;z-index:2000;left:0;top:0;width:100%;height:100%;background-color:rgba(0,0,0,0.7)}
.modal.show{display:flex;justify-content:center;align-items:center}
.modal-content{background-color:#444;padding:2rem;border-radius:8px;max-width:400px;width:90%;box-shadow:0 4px 20px rgba(0,0,0,0.5);max-height:90vh;overflow-y:auto}
.modal-header{font-size:1.5rem;font-weight:bold;margin-bottom:1.5rem;color:#00E5C0;text-align:center}
.menu-list{list-style:none;padding:0;margin:0}
.menu-item{padding:1rem;margin:0.5rem 0;background:#555;border-radius:4px;cursor:pointer;text-align:center;font-size:1.2rem}
.menu-item:hover{background:#00E5C0;color:#000}
.input-group{margin:1rem 0}
.input-group label{display:block;margin-bottom:0.5rem;color:#00E5C0;font-weight:bold}
.input-group input,.input-group select{width:100%;padding:0.5rem;background:#555;border:1px solid #666;color:white;font-size:1rem;border-radius:4px;box-sizing:border-box}
.input-group input:focus,.input-group select:focus{outline:none;border-color:#00E5C0}
.modal-buttons{display:flex;gap:1rem;margin-top:1.5rem}
.modal-btn{flex:1;padding:0.7rem;border:none;border-radius:4px;font-size:1rem;font-weight:bold;cursor:pointer}
.modal-btn.save{background:#00E5C0;color:#000}
.modal-btn.save:hover{background:#00c9a8}
.modal-btn.cancel{background:#666;color:white}
.modal-btn.cancel:hover{background:#777}
.modal-btn.default{background:#ff8800;color:#000}
.modal-btn.default:hover{background:#ff9922}
.modal-btn.delete{background:#ff4444;color:white}
.modal-btn.delete:hover{background:#ff6666}
.modal-btn:disabled{background:#444;color:#666;cursor:not-allowed}
.main-container{display:flex;flex-direction:column;align-items:center;width:100%;max-width:1000px;height:100%;padding:1rem;box-sizing:border-box}
.info-section{flex-shrink:0;width:100%}
.table-section{flex:1;overflow-y:auto;width:100%;min-height:0}
.controls-section{flex-shrink:0;width:100%;padding:1rem 0 0 0}
.info-row{display:flex;justify-content:center;gap:2rem;margin:1rem 0;flex-wrap:nowrap}
.label{font-size:2rem;font-weight:bold;white-space:nowrap}
#temperature{font-size:7rem;font-weight:bold;color:#00E5C0;margin:2rem 0;text-align:center;width:100%}
#temperature.error{color:#ff4444}
table{width:100%;max-width:1000px;border-collapse:collapse;background:#444}
td{border:1px solid #666;padding:0.5rem;text-align:center}
td input{width:100%;background:transparent;border:none;color:white;text-align:center;font-size:1rem;outline:none}
td input:disabled{color:#888;cursor:not-allowed}
.table-row-wrapper{display:flex;align-items:center;margin-bottom:0.5rem}
.table-controls{width:100%;max-width:1000px;margin-top:0;padding-bottom:1rem;display:flex;justify-content:center;gap:1rem}
.add-btn,.start-btn{background:#00E5C0;color:#000;font-weight:bold;padding:0.5rem 1rem;border:none;cursor:pointer;font-size:1rem;border-radius:4px;flex:1;max-width:200px}
.add-btn:hover,.start-btn:hover{background:#00c9a8}
.add-btn:disabled,.start-btn:disabled{background:#666;cursor:not-allowed}
.start-btn.stop{background:#ff4444}
.start-btn.stop:hover{background:#ff6666}
.error-banner{background:#ff4444;color:white;padding:1rem;text-align:center;font-weight:bold;display:none;width:100%;box-sizing:border-box}
.error-banner.show{display:block}
.update-status{margin:1rem 0;padding:1rem;background:#555;border-radius:4px;text-align:center}
.update-status.success{background:#00E5C0;color:#000}
.update-status.error{background:#ff4444}
.progress-bar{width:100%;height:20px;background:#555;border-radius:10px;overflow:hidden;margin:1rem 0}
.progress-fill{height:100%;background:#00E5C0;transition:width 0.3s}
.network-list{max-height:300px;overflow-y:auto}
.network-item{padding:0.8rem;margin:0.5rem 0;background:#555;border-radius:4px;cursor:pointer;display:flex;justify-content:space-between;align-items:center}
.network-item:hover{background:#666}
.network-item.selected{background:#00E5C0;color:#000}
.network-item.saved{border:2px solid #00E5C0}
.network-badge{font-size:0.8rem;padding:0.2rem 0.5rem;background:#00E5C0;color:#000;border-radius:3px;margin-left:0.5rem}
.saved-network-item{padding:0.8rem;margin:0.5rem 0;background:#555;border-radius:4px;display:flex;justify-content:space-between;align-items:center}
.saved-network-item.current{background:#00E5C0;color:#000}
.delete-btn{padding:0.3rem 0.8rem;background:#ff4444;color:white;border:none;border-radius:4px;cursor:pointer;font-size:0.9rem}
.delete-btn:hover{background:#ff6666}
@media(max-width:600px){
body{height:100dvh}
.main-container{padding:0.5rem}
.menu-icon{font-size:1.5rem;top:0.5rem;right:0.5rem}
.connection-status{font-size:0.8rem;padding:0.3rem 0.6rem;top:0.5rem;left:0.5rem}
#temperature{font-size:4rem;margin:1rem 0}
.label{font-size:1.3rem}
.info-row{gap:1rem;margin:0.5rem 0}
}
</style>
</head>
<body>
<div class="connection-status disconnected" id="connectionStatus">‚óè –ü–æ–¥–∫–ª—é—á–µ–Ω–∏–µ...</div>
<div class="menu-icon" onclick="openMainMenu()">‚ò∞</div>
<div class="error-banner" id="errorBanner">‚ö†Ô∏è –û–®–ò–ë–ö–ê: –ü–æ—Ç–µ—Ä—è —Å–≤—è–∑–∏ —Å –∫–æ–Ω—Ç—Ä–æ–ª–ª–µ—Ä–æ–º!</div>

<div id="mainMenuModal" class="modal">
<div class="modal-content">
<div class="modal-header">–ú–µ–Ω—é</div>
<ul class="menu-list">
<li class="menu-item" onclick="openPIDMenu()">‚öôÔ∏è PID –Ω–∞—Å—Ç—Ä–æ–π–∫–∏</li>
<li class="menu-item" onclick="openHysteresisMenu()">üìä –ì–∏—Å—Ç–µ—Ä–µ–∑–∏—Å</li>
<li class="menu-item" onclick="openCalibrationMenu()">üå°Ô∏è –ö–∞–ª–∏–±—Ä–æ–≤–∫–∞ —Ç–µ–º–ø–µ—Ä–∞—Ç—É—Ä—ã</li>
<li class="menu-item" onclick="openWiFiMenu()">üì° –ü–∞—Ä–∞–º–µ—Ç—Ä—ã —Å–µ—Ç–∏</li>
<li class="menu-item" onclick="openUpdateMenu()">üîÑ –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ —Å–∏—Å—Ç–µ–º—ã</li>
<li class="menu-item" onclick="closeModal('mainMenuModal')">‚ùå –ó–∞–∫—Ä—ã—Ç—å</li>
</ul>
</div>
</div>

<div id="pidModal" class="modal">
<div class="modal-content">
<div class="modal-header">–ù–∞—Å—Ç—Ä–æ–π–∫–∏ PID</div>
<div class="input-group">
<label>Kp (–ø—Ä–æ–ø–æ—Ä—Ü–∏–æ–Ω–∞–ª—å–Ω—ã–π):</label>
<input type="number" id="kpInput" step="0.1" value="2">
</div>
<div class="input-group">
<label>Ki (–∏–Ω—Ç–µ–≥—Ä–∞–ª—å–Ω—ã–π):</label>
<input type="number" id="kiInput" step="0.1" value="5">
</div>
<div class="input-group">
<label>Kd (–¥–∏—Ñ—Ñ–µ—Ä–µ–Ω—Ü–∏–∞–ª—å–Ω—ã–π):</label>
<input type="number" id="kdInput" step="0.1" value="1">
</div>
<div class="modal-buttons">
<button class="modal-btn default" onclick="resetPIDDefaults()">–ü–æ —É–º–æ–ª—á–∞–Ω–∏—é</button>
<button class="modal-btn cancel" onclick="closeModal('pidModal')">–û—Ç–º–µ–Ω–∞</button>
<button class="modal-btn save" onclick="savePID()">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å</button>
</div>
</div>
</div>

<div id="hysteresisModal" class="modal">
<div class="modal-content">
<div class="modal-header">–ù–∞—Å—Ç—Ä–æ–π–∫–∞ –≥–∏—Å—Ç–µ—Ä–µ–∑–∏—Å–∞</div>
<div class="input-group">
<label>–î–æ–ø—É—Å–∫ —Ç–µ–º–ø–µ—Ä–∞—Ç—É—Ä—ã (¬∞C):</label>
<input type="number" id="toleranceInput" step="0.1" value="2.0">
</div>
<div class="modal-buttons">
<button class="modal-btn default" onclick="resetHysteresisDefault()">–ü–æ —É–º–æ–ª—á–∞–Ω–∏—é</button>
<button class="modal-btn cancel" onclick="closeModal('hysteresisModal')">–û—Ç–º–µ–Ω–∞</button>
<button class="modal-btn save" onclick="saveHysteresis()">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å</button>
</div>
</div>
</div>

<div id="calibrationModal" class="modal">
<div class="modal-content">
<div class="modal-header">–ö–∞–ª–∏–±—Ä–æ–≤–∫–∞ —Ç–µ–º–ø–µ—Ä–∞—Ç—É—Ä—ã</div>
<div class="input-group">
<label>–°–º–µ—â–µ–Ω–∏–µ —Ç–µ–º–ø–µ—Ä–∞—Ç—É—Ä—ã (¬∞C):</label>
<input type="number" id="offsetInput" step="0.1" value="0" min="-20" max="20">
</div>
<div class="input-group">
<label>–ö–æ—ç—Ñ—Ñ–∏—Ü–∏–µ–Ω—Ç –º–∞—Å—à—Ç–∞–±–∞:</label>
<input type="number" id="gainInput" step="0.001" value="1.000" min="0.7" max="1.3">
</div>
<div class="modal-buttons">
<button class="modal-btn default" onclick="resetCalibrationDefaults()">–ü–æ —É–º–æ–ª—á–∞–Ω–∏—é</button>
<button class="modal-btn cancel" onclick="closeModal('calibrationModal')">–û—Ç–º–µ–Ω–∞</button>
<button class="modal-btn save" onclick="saveCalibration()">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å</button>
</div>
</div>
</div>

<div id="wifiModal" class="modal">
<div class="modal-content">
<div class="modal-header">–ü–∞—Ä–∞–º–µ—Ç—Ä—ã —Å–µ—Ç–∏</div>
<div class="input-group">
<label>–¢–µ–∫—É—â–∞—è —Å–µ—Ç—å:</label>
<div style="background:#555;padding:0.8rem;border-radius:4px;margin-top:0.5rem">
<div><strong id="currentSSID">-</strong></div>
<div style="font-size:0.9rem;color:#aaa;margin-top:0.3rem">
IP: <span id="wifiIP">-</span><br>
–†–µ–∂–∏–º: <span id="wifiMode">-</span>
</div>
</div>
</div>
<div style="margin:1.5rem 0">
<label style="color:#00E5C0;font-weight:bold;margin-bottom:0.5rem;display:block">–°–æ—Ö—Ä–∞–Ω—ë–Ω–Ω—ã–µ —Å–µ—Ç–∏:</label>
<div id="savedNetworksList"></div>
</div>
<div class="modal-buttons">
<button class="modal-btn save" onclick="scanWiFi()">üîç –ù–∞–π—Ç–∏ –Ω–æ–≤—É—é —Å–µ—Ç—å</button>
</div>
<div id="networkList" class="network-list" style="display:none"></div>
<div class="input-group" id="wifiPasswordGroup" style="display:none">
<label>–ü–∞—Ä–æ–ª—å –¥–ª—è <span id="selectedSSID"></span>:</label>
<input type="password" id="wifiPasswordInput">
</div>
<div class="modal-buttons" id="wifiConnectButtons" style="display:none">
<button class="modal-btn cancel" onclick="cancelWiFiConnect()">–û—Ç–º–µ–Ω–∞</button>
<button class="modal-btn save" onclick="connectWiFi()">–ü–æ–¥–∫–ª—é—á–∏—Ç—å—Å—è</button>
</div>
<div class="modal-buttons">
<button class="modal-btn cancel" onclick="closeModal('wifiModal')">–ó–∞–∫—Ä—ã—Ç—å</button>
</div>
</div>
</div>

<div id="updateModal" class="modal">
<div class="modal-content">
<div class="modal-header">–û–±–Ω–æ–≤–ª–µ–Ω–∏–µ —Å–∏—Å—Ç–µ–º—ã</div>
<div class="update-status" id="updateStatus">
<div>–¢–µ–∫—É—â–∞—è –≤–µ—Ä—Å–∏—è: <strong id="currentVersion">-</strong></div>
<div id="latestVersionDiv" style="display:none">–î–æ—Å—Ç—É–ø–Ω–∞ –≤–µ—Ä—Å–∏—è: <strong id="latestVersion">-</strong></div>
<div id="changesDiv" style="display:none;margin-top:1rem;text-align:left"></div>
</div>
<div class="progress-bar" id="progressBar" style="display:none">
<div class="progress-fill" id="progressFill"></div>
</div>
<div id="updateMessage" style="margin-top:1rem;text-align:center"></div>
<div class="modal-buttons">
<button class="modal-btn save" id="checkUpdateBtn" onclick="checkUpdate()">üîç –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è</button>
<button class="modal-btn save" id="updateBtn" onclick="startUpdate()" style="display:none">‚¨áÔ∏è –û–±–Ω–æ–≤–∏—Ç—å</button>
<button class="modal-btn cancel" onclick="closeModal('updateModal')">–ó–∞–∫—Ä—ã—Ç—å</button>
</div>
</div>
</div>

<div class="main-container">
<div class="info-section">
<div class="info-row">
<div class="label" id="totalTime">00:00:00</div>
<div class="label">–º–æ—â–Ω–æ—Å—Ç—å: <span id="dutyCycle">0%</span></div>
</div>
<div id="temperature">0.0¬∞C</div>
<div class="info-row">
<div class="label" id="mode">–û–∂–∏–¥–∞–Ω–∏–µ</div>
<div class="label" id="setTemperature">0¬∞C</div>
</div>
<div class="info-row">
<div class="label" id="modeTime">00:00:00</div>
<div class="label">/</div>
<div class="label" id="leftTime">00:00:00</div>
</div>
</div>
<div class="table-section">
<div id="programContainer" class="drag-container"></div>
</div>
<div class="controls-section">
<div class="table-controls">
<button class="add-btn" id="addBtn" onclick="addRow()">‚ûï –î–æ–±–∞–≤–∏—Ç—å</button>
<button class="start-btn" id="startBtn" onclick="toggleProgram()">‚ñ∂Ô∏è –°—Ç–∞—Ä—Ç</button>
</div>
</div>
</div>
<script src="https://cdn.jsdelivr.net/npm/sortablejs@1.15.0/Sortable.min.js"></script>
<script>
let ws;
let wsReconnectInterval;
let programRunning=false;
let finishedTime=0;
let selectedNetwork='';
let connectionLost=false;

function connectWebSocket(){
const protocol=window.location.protocol==='https:'?'wss:':'ws:';
const host=window.location.hostname;
const wsUrl=protocol+'//'+host+':81';

ws=new WebSocket(wsUrl);

ws.onopen=()=>{
console.log('WebSocket connected');
document.getElementById('connectionStatus').textContent='‚óè –ü–æ–¥–∫–ª—é—á–µ–Ω–æ';
document.getElementById('connectionStatus').classList.remove('disconnected');
document.getElementById('connectionStatus').classList.add('connected');
document.getElementById('errorBanner').classList.remove('show');
connectionLost=false;
clearInterval(wsReconnectInterval);
};

ws.onmessage=(event)=>{
try{
const data=JSON.parse(event.data);
updateUIFromData(data);
}catch(e){
console.error('Error parsing WebSocket message:',e);
}
};

ws.onclose=()=>{
console.log('WebSocket disconnected');
document.getElementById('connectionStatus').textContent='‚óè –û—Ç–∫–ª—é—á–µ–Ω–æ';
document.getElementById('connectionStatus').classList.remove('connected');
document.getElementById('connectionStatus').classList.add('disconnected');
if(!connectionLost){
document.getElementById('errorBanner').classList.add('show');
connectionLost=true;
}
wsReconnectInterval=setInterval(connectWebSocket,3000);
};

ws.onerror=(error)=>{
console.error('WebSocket error:',error);
ws.close();
};
}

function updateUIFromData(data){
const tempElement=document.getElementById('temperature');
if(data.temperature==="ERROR"||data.watchdog_error){
tempElement.textContent="ERROR";
tempElement.classList.add('error');
document.getElementById('errorBanner').classList.add('show');
}else{
tempElement.textContent=(typeof data.temperature==='number'?data.temperature.toFixed(1):data.temperature)+"¬∞C";
tempElement.classList.remove('error');
}

document.getElementById('mode').textContent=data.mode;

if(data.state==='FINISHED'){
document.getElementById('setTemperature').textContent='---';
if(finishedTime===0)finishedTime=Date.now();
}else{
document.getElementById('setTemperature').textContent=data.set_temperature+"¬∞C";
finishedTime=0;
}

document.getElementById('modeTime').textContent=data.mode_time;
document.getElementById('leftTime').textContent=data.time_left;
document.getElementById('totalTime').textContent=data.total_time;
document.getElementById('dutyCycle').textContent=Math.round(data.duty_cycle)+"%";

if(data.state==='RUNNING'&&!programRunning){
programRunning=true;
updateUIState();
}else if(data.state==='IDLE'&&programRunning){
programRunning=false;
finishedTime=0;
updateUIState();
}
}

function openMainMenu(){
closeModal('pidModal');
closeModal('hysteresisModal');
closeModal('calibrationModal');
closeModal('wifiModal');
closeModal('updateModal');
document.getElementById('mainMenuModal').classList.add('show');
}

function openPIDMenu(){
closeModal('mainMenuModal');
loadPIDSettings();
document.getElementById('pidModal').classList.add('show');
}

function openHysteresisMenu(){
closeModal('mainMenuModal');
loadHysteresisSettings();
document.getElementById('hysteresisModal').classList.add('show');
}

function openCalibrationMenu(){
closeModal('mainMenuModal');
loadCalibrationSettings();
document.getElementById('calibrationModal').classList.add('show');
}

function openWiFiMenu(){
closeModal('mainMenuModal');
loadWiFiStatus();
loadSavedNetworks();
document.getElementById('wifiModal').classList.add('show');
}

function openUpdateMenu(){
closeModal('mainMenuModal');
document.getElementById('updateModal').classList.add('show');
loadCurrentVersion();
}

function closeModal(id){
document.getElementById(id).classList.remove('show');
if(id==='wifiModal'){
document.getElementById('networkList').style.display='none';
cancelWiFiConnect();
}
}

function resetPIDDefaults(){
document.getElementById('kpInput').value='2';
document.getElementById('kiInput').value='5';
document.getElementById('kdInput').value='1';
}

function resetHysteresisDefault(){
document.getElementById('toleranceInput').value='2.0';
}

function resetCalibrationDefaults(){
document.getElementById('offsetInput').value='0';
document.getElementById('gainInput').value='1.000';
}

function loadPIDSettings(){
fetch('/get_pid')
.then(response=>response.json())
.then(data=>{
document.getElementById('kpInput').value=data.kp;
document.getElementById('kiInput').value=data.ki;
document.getElementById('kdInput').value=data.kd;
})
.catch(error=>console.error('Error:',error));
}

function loadHysteresisSettings(){
fetch('/get_hysteresis')
.then(response=>response.json())
.then(data=>{
document.getElementById('toleranceInput').value=data.tolerance;
})
.catch(error=>console.error('Error:',error));
}

function loadCalibrationSettings(){
fetch('/get_calibration')
.then(response=>response.json())
.then(data=>{
document.getElementById('offsetInput').value=data.offset;
document.getElementById('gainInput').value=data.gain.toFixed(3);
})
.catch(error=>console.error('Error:',error));
}

function savePID(){
const kp=parseFloat(document.getElementById('kpInput').value);
const ki=parseFloat(document.getElementById('kiInput').value);
const kd=parseFloat(document.getElementById('kdInput').value);
if(isNaN(kp)||isNaN(ki)||isNaN(kd)){
alert('–ü—Ä–æ–≤–µ—Ä—å—Ç–µ –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ—Å—Ç—å –¥–∞–Ω–Ω—ã—Ö');
return;
}
fetch('/set_pid',{
method:'POST',
headers:{'Content-Type':'application/json'},
body:JSON.stringify({kp:kp,ki:ki,kd:kd})
})
.then(response=>response.text())
.then(data=>{
alert('PID –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ —Å–æ—Ö—Ä–∞–Ω–µ–Ω—ã');
closeModal('pidModal');
})
.catch(error=>alert('–û—à–∏–±–∫–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è'));
}

function saveHysteresis(){
const tolerance=parseFloat(document.getElementById('toleranceInput').value);
if(isNaN(tolerance)||tolerance<=0){
alert('–ü—Ä–æ–≤–µ—Ä—å—Ç–µ –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ—Å—Ç—å –¥–∞–Ω–Ω—ã—Ö');
return;
}
fetch('/set_hysteresis',{
method:'POST',
headers:{'Content-Type':'application/json'},
body:JSON.stringify({tolerance:tolerance})
})
.then(response=>response.text())
.then(data=>{
alert('–ì–∏—Å—Ç–µ—Ä–µ–∑–∏—Å —Å–æ—Ö—Ä–∞–Ω–µ–Ω');
closeModal('hysteresisModal');
})
.catch(error=>alert('–û—à–∏–±–∫–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è'));
}

function saveCalibration(){
const offset=parseFloat(document.getElementById('offsetInput').value);
const gain=parseFloat(document.getElementById('gainInput').value);
if(isNaN(offset)||isNaN(gain)){
alert('–ü—Ä–æ–≤–µ—Ä—å—Ç–µ –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ—Å—Ç—å –¥–∞–Ω–Ω—ã—Ö');
return;
}
fetch('/set_calibration',{
method:'POST',
headers:{'Content-Type':'application/json'},
body:JSON.stringify({offset:offset,gain:gain})
})
.then(response=>response.text())
.then(data=>{
alert('–ö–∞–ª–∏–±—Ä–æ–≤–∫–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∞');
closeModal('calibrationModal');
})
.catch(error=>alert('–û—à–∏–±–∫–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è'));
}

function loadWiFiStatus(){
fetch('/wifi/status')
.then(response=>response.json())
.then(data=>{
document.getElementById('wifiMode').textContent=data.mode==='AP'?'–¢–æ—á–∫–∞ –¥–æ—Å—Ç—É–ø–∞':'–ö–ª–∏–µ–Ω—Ç';
document.getElementById('wifiIP').textContent=data.ip;
document.getElementById('currentSSID').textContent=data.ssid;
})
.catch(error=>console.error('Error:',error));
}

function loadSavedNetworks(){
fetch('/wifi/saved')
.then(response=>response.json())
.then(data=>{
const list=document.getElementById('savedNetworksList');
list.innerHTML='';
if(data.length===0){
list.innerHTML='<div style="text-align:center;color:#888;padding:1rem">–ù–µ—Ç —Å–æ—Ö—Ä–∞–Ω—ë–Ω–Ω—ã—Ö —Å–µ—Ç–µ–π</div>';
return;
}
data.forEach(network=>{
const item=document.createElement('div');
item.className='saved-network-item'+(network.current?' current':'');
item.innerHTML='<span>'+network.ssid+(network.current?' (—Ç–µ–∫—É—â–∞—è)':'')+'</span>';
if(!network.current){
const deleteBtn=document.createElement('button');
deleteBtn.className='delete-btn';
deleteBtn.textContent='–£–¥–∞–ª–∏—Ç—å';
deleteBtn.onclick=()=>deleteNetwork(network.ssid);
item.appendChild(deleteBtn);
}
list.appendChild(item);
});
})
.catch(error=>console.error('Error:',error));
}

function deleteNetwork(ssid){
if(!confirm('–£–¥–∞–ª–∏—Ç—å —Å–µ—Ç—å "'+ssid+'"?'))return;
fetch('/wifi/delete',{
method:'POST',
headers:{'Content-Type':'application/json'},
body:JSON.stringify({ssid:ssid})
})
.then(response=>response.text())
.then(data=>{
loadSavedNetworks();
})
.catch(error=>alert('–û—à–∏–±–∫–∞ —É–¥–∞–ª–µ–Ω–∏—è'));
}

function scanWiFi(){
document.getElementById('networkList').style.display='block';
document.getElementById('networkList').innerHTML='<div style="text-align:center;padding:1rem">–°–∫–∞–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ...</div>';
fetch('/wifi/scan')
.then(response=>response.json())
.then(data=>{
const list=document.getElementById('networkList');
list.innerHTML='';
data.forEach(network=>{
const item=document.createElement('div');
item.className='network-item'+(network.saved?' saved':'');
const badge=network.saved?'<span class="network-badge">–°–æ—Ö—Ä–∞–Ω–µ–Ω–∞</span>':'';
item.innerHTML='<span>'+network.ssid+badge+'</span><span>'+network.rssi+' dBm</span>';
item.onclick=()=>selectNetwork(network.ssid,item);
list.appendChild(item);
});
})
.catch(error=>{
document.getElementById('networkList').innerHTML='<div style="text-align:center;color:#ff4444">–û—à–∏–±–∫–∞ —Å–∫–∞–Ω–∏—Ä–æ–≤–∞–Ω–∏—è</div>';
});
}

function selectNetwork(ssid,element){
selectedNetwork=ssid;
document.querySelectorAll('.network-item').forEach(item=>item.classList.remove('selected'));
element.classList.add('selected');
document.getElementById('selectedSSID').textContent=ssid;
document.getElementById('wifiPasswordGroup').style.display='block';
document.getElementById('wifiConnectButtons').style.display='flex';
}

function cancelWiFiConnect(){
selectedNetwork='';
document.getElementById('wifiPasswordGroup').style.display='none';
document.getElementById('wifiConnectButtons').style.display='none';
document.getElementById('wifiPasswordInput').value='';
document.querySelectorAll('.network-item').forEach(item=>item.classList.remove('selected'));
}

function connectWiFi(){
const password=document.getElementById('wifiPasswordInput').value;
fetch('/wifi/connect',{
method:'POST',
headers:{'Content-Type':'application/json'},
body:JSON.stringify({ssid:selectedNetwork,password:password})
})
.then(response=>response.text())
.then(data=>{
alert('–ü–æ–¥–∫–ª—é—á–µ–Ω–∏–µ –∫ —Å–µ—Ç–∏...\n–ü–æ–¥–æ–∂–¥–∏—Ç–µ 20 —Å–µ–∫—É–Ω–¥.\n–ï—Å–ª–∏ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏–µ —É—Å–ø–µ—à–Ω–æ, –∫–æ–Ω—Ç—Ä–æ–ª–ª–µ—Ä –±—É–¥–µ—Ç –¥–æ—Å—Ç—É–ø–µ–Ω –ø–æ –Ω–æ–≤–æ–º—É IP –∞–¥—Ä–µ—Å—É.\n\n–ü—Ä–æ–≤–µ—Ä—å—Ç–µ IP –∞–¥—Ä–µ—Å –≤ –Ω–∞—Å—Ç—Ä–æ–π–∫–∞—Ö —Ä–æ—É—Ç–µ—Ä–∞.');
cancelWiFiConnect();
setTimeout(()=>{
loadWiFiStatus();
loadSavedNetworks();
},20000);
})
.catch(error=>alert('–û—à–∏–±–∫–∞ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è'));
}

function loadCurrentVersion(){
fetch('/status')
.then(response=>response.json())
.then(data=>{
document.getElementById('currentVersion').textContent=data.firmware_version;
})
.catch(error=>console.error('Error:',error));
}

function checkUpdate(){
document.getElementById('checkUpdateBtn').disabled=true;
document.getElementById('checkUpdateBtn').textContent='–ü—Ä–æ–≤–µ—Ä–∫–∞...';
fetch('/update/check')
.then(response=>response.json())
.then(data=>{
document.getElementById('currentVersion').textContent=data.current_version;
if(data.update_available){
document.getElementById('latestVersionDiv').style.display='block';
document.getElementById('latestVersion').textContent=data.latest_version;
document.getElementById('changesDiv').style.display='block';
document.getElementById('changesDiv').innerHTML='<strong>–ò–∑–º–µ–Ω–µ–Ω–∏—è:</strong><br>'+data.changes.replace(/\n/g,'<br>');
document.getElementById('updateBtn').style.display='block';
}else{
document.getElementById('updateMessage').textContent='‚úÖ –£ –≤–∞—Å —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∞ –ø–æ—Å–ª–µ–¥–Ω—è—è –≤–µ—Ä—Å–∏—è';
document.getElementById('latestVersionDiv').style.display='none';
document.getElementById('changesDiv').style.display='none';
}
document.getElementById('checkUpdateBtn').disabled=false;
document.getElementById('checkUpdateBtn').textContent='üîç –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è';
})
.catch(error=>{
document.getElementById('updateMessage').textContent='‚ùå –û—à–∏–±–∫–∞ –ø—Ä–æ–≤–µ—Ä–∫–∏ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–π';
document.getElementById('